import{s as Ze,V as et,j as e,I as tt,W as q,G as te,B as p,T as w,e as ue,J as Ce,ab as we,g as Se,ad as Ie}from"./mui-5MYSBV5R.js";import{r as u}from"./reactVendor-BAhb8EbJ.js";import{u as W}from"./lang-BFcXlKUT.js";import{c as ge}from"./lodashEs-Ck10JMnh.js";import{u as M,R as ke,a5 as Z,a as oe,aj as Y,a9 as nt,_ as Ae,a2 as se,ak as Be,al as K,am as pe,an as ne,ao as ot,G as st,ac as rt,ap as be}from"./react-setup-B89zJiq4.js";import"../index.CgW3dhwJ.js";import{b as ce}from"./b3Logger-CMQiGC3f.js";import{i as it,g as De,a as at,b as ct,e as lt,c as dt,d as ut}from"./payment-D2qoSvp-.js";import{u as pt}from"./useSort-Cu2YrCwH.js";import{B as xt}from"./B3Filter-B8HZ1N9c.js";import{d as ft}from"./MoreHoriz-DmGsxDzl.js";import{u as re,a as mt}from"./router-BbCjXwHs.js";import{R as ht}from"./resizable-CyxYMIhD.js";import{P as yt}from"./pdfobject-BVlZ-mQx.js";import{n as gt}from"./eStyled-BQSmO2oX.js";import"./eReact-DeS39u1B.js";import"./intl-CIPMD0ue.js";import"./eCache-BQInSoPa.js";import"./redux-B-shcavw.js";import"./toolkit-CHPG993j.js";import"./muiIcon-Du0m7JKT.js";import"./dateFns-CE3kB2v1.js";import"./dropzone-CHkuoC7V.js";import"./b3checkout-CbVlU3jI.js";import"./B3FilterMore-D4S_BlgN.js";import"./form-Bvi8lP6x.js";import"./B3CustomForm-DjrjSYXN.js";import"./B3FilterSearch-zd7_SPrR.js";const bt=i=>new Promise((n,o)=>{fetch(i).then(a=>a.blob()).then(a=>{const x=new Blob([a],{type:"application/pdf"}),g=window.URL.createObjectURL(x);n(g)}).catch(a=>{o(a)})}),Pe=async(i,n=!1)=>{const{invoicePdf:{url:o}}=await it(+i,n);return o},xe=async(i,n=!1)=>{let o="";try{return o=await Pe(i,n),await bt(o)}catch(a){return o}},vt=Ze(et)(()=>({"& .MuiPaper-elevation":{boxShadow:"0px 1px 0px -1px rgba(0, 0, 0, 0.1), 0px 1px 6px rgba(0, 0, 0, 0.07), 0px 1px 4px rgba(0, 0, 0, 0.06)",borderRadius:"4px"}}));function Fe({row:i,setIsRequestLoading:n,setInvoiceId:o,handleOpenHistoryModal:a}){const x=M(({global:d})=>d.storeInfo.platform),g=u.useRef(null),[y,m]=u.useState(!1),[P,v]=u.useState(!0),S=re(),h=W(),{getOrderPermission:A,invoicePayPermission:k,purchasabilityPermission:T}=M(ke),L=()=>{m(!1)},E=()=>{const{id:d}=i;o(d),m(!0)},O=async d=>{const{id:D}=i;L(),n(!0);const C=await xe(D,d);if(n(!1),!C){Z.error("pdf url resolution error");return}const{href:$}=window.location;$.includes("invoice")&&window.open(C,"_blank","fullscreen=yes")},R=()=>{const{orderNumber:d}=i;L(),S("/orderDetail/".concat(d))},B=async()=>{L();const{openBalance:d,originalBalance:D,id:C}=i,$={lineItems:[{invoiceId:+C,amount:d.value==="."?"0":"".concat(+d.value)}],currency:(d==null?void 0:d.code)||D.code};if(d.value==="."||+d.value==0){Z.error("The payment amount entered has an invalid value.",{isClose:!0});return}await De($,x,!1)},z=async()=>{L(),a(!0)},J=async()=>{const{id:d}=i;L(),n(!0);const D=await Pe(d);n(!1);const C=document.createElement("a");C.href=D,C.target="_blank",C.download="file.pdf",C.click()};return u.useEffect(()=>{const{openBalance:d}=i,D=+d.value>0&&k&&T;v(D)},[]),e.jsxs(e.Fragment,{children:[e.jsx(tt,{onClick:E,ref:g,children:e.jsx(ft,{})}),e.jsxs(vt,{id:"basic-menu",anchorEl:g.current,open:y,onClose:L,MenuListProps:{"aria-labelledby":"basic-button"},anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[e.jsx(q,{sx:{color:"primary.main"},onClick:()=>O(i.status!==2&&k&&T),children:h("invoice.actions.viewInvoice")},"View-invoice"),A&&e.jsx(q,{sx:{color:"primary.main"},onClick:R,children:h("invoice.actions.viewOrder")},"View-Order"),i.status!==0&&e.jsx(q,{sx:{color:"primary.main"},onClick:z,children:h("invoice.actions.viewPaymentHistory")},"View-payment-history"),P&&e.jsx(q,{sx:{color:"primary.main"},onClick:B,children:h("invoice.actions.pay")},"Pay"),e.jsx(q,{sx:{color:"primary.main"},onClick:()=>O(i.status!==2&&k&&T),children:h("invoice.actions.print")},"Print"),e.jsx(q,{sx:{color:"primary.main"},onClick:()=>J(),children:h("invoice.actions.download")},"Download")]})]})}function jt(i){const n=M(({global:k})=>k.storeInfo.platform),o=W(),[a]=oe(),[x,g]=u.useState(0),[y,m]=u.useState("$"),P=M(({b2bFeatures:k})=>k.masqueradeCompany.isAgenting),v=a?{alignItems:"flex-start",flexDirection:"column"}:{alignItems:"center"},{selectedPay:S,decimalPlaces:h}=i,A=async()=>{const k=[];let T="SGD";if(S.length>0){if(S.forEach(O=>{const{node:{id:R,openBalance:B,originalBalance:z}}=O;k.push({invoiceId:+R,amount:B.value==="."?"0":"".concat(+B.value)}),T=(B==null?void 0:B.code)||z.code}),k.find(O=>O.amount==="."||+O.amount==0)){Z.error(o("invoice.footer.invalidNameError"),{isClose:!0});return}await De({lineItems:k,currency:T},n,!1)}};return u.useEffect(()=>{if(S.length>0){const k=E=>{let O=0;E.forEach(R=>{const{node:{openBalance:B}}=R;O+=B.value==="."?0:+B.value}),g(O.toFixed(h))},{node:{openBalance:T}}=S[0],L=Y(T.code);m(L),k(S)}},[h,S]),e.jsxs(te,{sx:{position:"fixed",bottom:a&&P?"52px":0,left:0,backgroundColor:"#fff",width:"100%",padding:a?"0 0 1rem 0":"0 40px 1rem 40px",height:a?"8rem":"auto",marginLeft:0,display:"flex",flexWrap:"nowrap",zIndex:"999"},container:!0,spacing:2,children:[e.jsx(te,{item:!0,sx:{display:a?"none":"block",width:"290px",paddingLeft:"20px"}}),e.jsx(te,{item:!0,sx:a?{flexBasis:"100%"}:{flexBasis:"690px",flexGrow:1},children:e.jsxs(p,{sx:{width:"100%",pr:"20px",display:"flex",zIndex:"999",justifyContent:"space-between",...v},children:[e.jsx(w,{sx:{color:"#000000",fontSize:"16px",fontWeight:"400"},children:o("invoice.footer.invoiceSelected",{invoices:S.length})}),e.jsxs(p,{sx:{display:"flex",alignItems:"center",flexWrap:a?"wrap":"nowrap",width:a?"100%":"auto"},children:[e.jsx(w,{variant:"h6",sx:{fontSize:"16px",fontWeight:"700",color:"#000000"},children:o("invoice.footer.totalPayment",{total:"".concat(y).concat(x)})}),e.jsx(p,{sx:{display:"flex",alignItems:"center",marginTop:a?"0.5rem":0,width:a?"100%":"auto"},children:e.jsx(ue,{variant:"contained",sx:{marginLeft:a?0:"1rem",width:a?"100%":"auto"},onClick:()=>{A()},children:o("invoice.footer.payInvoices")})})]})]})}),e.jsx(te,{item:!0,sx:a?{flexBasis:"100%",display:a?"none":"block"}:{flexBasis:"0",display:a?"none":"block"}})]})}function Te(i){const{code:n}=i,a=(x=>({0:{textColor:"#000000",name:"Open",color:"#F1C224"},1:{textColor:"#FFFFFF",name:"Partially paid",color:"#516FAE"},2:{textColor:"#000000",name:"Paid",color:"#C4DD6C"},3:{textColor:"#FFFFFF",name:"Overdue",color:"#D32F2F"}})[x]||{})(n);return a.name?e.jsx(nt,{color:a.color,textColor:a.textColor,children:a.name}):null}function X({title:i}){return e.jsxs(w,{sx:{fontWeight:"bold",pr:"5px"},children:[i,":"]})}function Ct({list:i}){return e.jsx(e.Fragment,{children:i.map(n=>{const{node:{createdAt:o,amount:a,paymentType:x,transactionType:g,referenceNumber:y,id:m}}=n;return e.jsx(Ce,{sx:{mb:"10px"},children:e.jsxs(we,{sx:{color:"#313440",wordBreak:"break-word"},children:[e.jsxs(p,{sx:{display:"flex"},children:[e.jsx(X,{title:"Date received"}),e.jsx(w,{variant:"body1",children:"".concat(K(+o))})]}),e.jsxs(p,{sx:{display:"flex"},children:[e.jsx(X,{title:"Amount"}),e.jsx(w,{variant:"body1",children:"".concat(pe(a.code,+((a==null?void 0:a.value)||0)))})]}),e.jsxs(p,{sx:{display:"flex"},children:[e.jsx(X,{title:"Transaction type"}),e.jsx(w,{variant:"body1",children:g})]}),e.jsxs(p,{sx:{display:"flex"},children:[e.jsx(X,{title:"Payment type"}),e.jsx(w,{variant:"body1",children:x})]}),e.jsxs(p,{sx:{display:"flex"},children:[e.jsx(X,{title:"Reference"}),e.jsx(w,{variant:"body1",children:y||"–"})]})]})},m)})})}function wt({open:i,setOpen:n,currentInvoiceId:o}){const a=W(),[x]=oe(),[g,y]=u.useState(!1),[m,P]=u.useState([]);return u.useEffect(()=>{i&&o&&(async()=>{y(!0);const{allReceiptLines:{edges:S=[]}}=await at(+o);P(S),y(!1)})()},[i,o]),e.jsx(Ae,{isOpen:i,leftSizeBtn:"",rightSizeBtn:"ok",title:a("invoice.paymentHistory.title"),showLeftBtn:!1,handRightClick:()=>n(!1),children:e.jsx(p,{sx:{width:x?"100%":"384px",maxHeight:"600px"},children:e.jsx(se,{isSpinning:g,children:e.jsx(p,{sx:{display:"flex",flexDirection:"column",flex:1},children:m.length?e.jsx(Ct,{list:m}):e.jsx(Be,{})})})})})}const U={NORMAL:"normal",DETAIL:"detail",CHECKOUT:"checkout"},St=[{key:"open",value:0,label:"Open"},{key:"partialPaid",value:1,label:"Partially paid"},{key:"paid",value:2,label:"Paid"},{key:"overdue",value:3,label:"Overdue"}],It=[{name:"status",label:"Status",required:!1,default:"",fieldType:"dropdown",xs:12,variant:"filled",size:"small",options:St}],ve={status:"invoice.filterStatus.title",open:"invoice.filterStatus.open",partialPaid:"invoice.filterStatus.partiallyPaid",paid:"invoice.filterStatus.paid",overdue:"invoice.filterStatus.overdue"},Le="id",Oe={id:"invoiceNumber",orderNumber:"orderNumber",createdAt:"createdAt",updatedAt:"dueDate",originalBalance:"originalBalanceAmount",openBalance:"openBalanceAmount",status:"status"},je={invoiceNumber:"invoice_number",orderNumber:"order_number",createdAt:"created_at",dueDate:"due_date",originalBalanceAmount:"original_balance_amount",openBalanceAmount:"open_balance_amount"};function de({title:i,withColon:n=!0}){return e.jsx(w,{sx:{fontWeight:"bold",pr:"5px"},children:n?"".concat(i,":"):i})}function kt({isRow:i=!0,type:n="",value:o,label:a,code:x}){const g=()=>{if(n==="time")return K(+o)||"";if(n==="currency"){const y=+(o||0);return pe(x,y)}if(n==="paymentType"){let y="".concat(o).trim();return o&&(y=y.slice(0,1).toUpperCase()+y.slice(1).toLowerCase()),y}return o||"–"};return e.jsxs(p,{sx:{display:"flex",flexDirection:i?"row":"column"},children:[e.jsx(de,{title:a}),e.jsx(w,{variant:"body1",children:"".concat(g())})]})}function At({list:i}){var y;const{receiptLineSet:{edges:n=[]},details:o}=i,a=((y=o==null?void 0:o.paymentDetails)==null?void 0:y.comment)||"",x=W(),g=[{key:"paymentId",label:"Payment#",type:"",isRow:!0,idLang:"payment.paymentNumber"},{key:"createdAt",label:"Payment received on",type:"time",isRow:!0,idLang:"payment.paymentReceivedOn"},{key:"transactionType",label:"Transaction type",type:"",isRow:!0,idLang:"payment.transactionType"},{key:"paymentType",label:"Payment type",type:"paymentType",isRow:!0,idLang:"payment.paymentType"},{key:"totalAmount",label:"Payment total",type:"currency",isRow:!0,idLang:"payment.paymentTotal"},{key:"referenceNumber",label:"Reference",type:"",isRow:!0,idLang:"payment.reference"}];return e.jsxs(p,{children:[g.map(m=>e.jsx(kt,{isRow:!!m.isRow,type:m.type,value:i[m.key],code:(i==null?void 0:i.totalCode)||"SGD",label:x(m.idLang)})),e.jsxs(p,{sx:{display:"flex",flexDirection:"column",mb:"30px"},children:[e.jsx(de,{title:x("payment.paymentComment")}),e.jsx(w,{sx:{maxHeight:"50px"},children:a})]}),e.jsxs(p,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(de,{title:x("payment.invoicesPaid"),withColon:!1}),e.jsxs(w,{variant:"body1",children:[x("payment.paymentTowardsInvoices")," "]})]}),e.jsxs(p,{children:[e.jsxs(p,{sx:{borderBottom:"1px solid #D9DCE9",padding:"20px 15px",display:"flex",justifyContent:"space-between",fontWeight:500},children:[e.jsx(w,{sx:{fontSize:"14px",fontWeight:"500",color:"#000000"},children:x("payment.invoiceNumber")}),e.jsx(w,{sx:{fontSize:"14px",fontWeight:"500",color:"#000000"},children:x("payment.amountPaid")})]}),n.map(m=>{const{invoiceNumber:P,amount:{value:v,code:S}}=m.node,h=+(v||0),A=pe(S,h);return e.jsxs(p,{sx:{borderBottom:"1px solid #D9DCE9",padding:"20px 15px",display:"flex",justifyContent:"space-between"},children:[e.jsx(w,{children:P}),e.jsx(w,{children:A})]})})]})]})}function Bt({receiptId:i,type:n}){const[o]=oe(),[a,x]=u.useState(!1),[g,y]=u.useState(!1),[m,P]=u.useState(null),v=re(),S=W();u.useEffect(()=>{const k=async()=>{x(!0);const{receipt:T}=await ct(+i);P(T),y(!0),x(!1)};n===U.CHECKOUT&&i&&k()},[i,n]);const h=()=>{y(!1),v("/invoice")},A=()=>e.jsx(ue,{onClick:h,variant:"text",children:S("payment.okButton")});return e.jsx(Ae,{isOpen:g,leftSizeBtn:"",customActions:A,title:S("payment.paymentSuccess"),showLeftBtn:!1,children:e.jsx(p,{sx:{width:o?"100%":"384px",maxHeight:"600px"},children:e.jsx(se,{isSpinning:a,children:e.jsx(p,{sx:{display:"flex",flexDirection:"column",flex:1},children:m?e.jsx(At,{list:m}):e.jsx(Be,{})})})})})}const Dt=300;function Pt({row:i}){var P,v;const n=u.useRef(null),o=u.useRef(null),[a,x]=u.useState(!1),[g,y]=u.useState(Dt),m=(S,{size:h})=>{y(h.height)};return u.useEffect(()=>((async()=>{x(!0);const{id:h}=i,A=await xe(h);if(!A){Z.error("pdf url resolution error");return}n!=null&&n.current&&(yt.embed(A,n.current),x(!1))})(),()=>{n.current=null}),[i]),e.jsx(se,{isSpinning:a,children:e.jsx(p,{ref:o,sx:{display:"flex",flexWrap:"wrap",width:"100%","& .box":{display:"flex",flexDirection:"column",overflow:"hidden",position:"relative",width:"100%","& .react-resizable":{position:"relative"},"& .react-resizable-handle":{position:"absolute",width:"100%",height:"30px",backgroundRepeat:"no-repeat",backgroundOrigin:"content-box",boxSizing:"border-box"},"& .react-resizable-handle-s":{cursor:"ns-resize",bottom:0}}},children:e.jsx(ht,{className:"box",height:g,minConstraints:[((P=o==null?void 0:o.current)==null?void 0:P.offsetWidth)||0,0],width:((v=o.current)==null?void 0:v.offsetWidth)||0,onResize:m,resizeHandles:["s"],children:e.jsx("div",{style:{width:"100%",height:"".concat(g,"px")},children:e.jsx("div",{ref:n,style:{height:"100%",width:"100%"}})})})})})}const Ft=gt(p)(()=>({"& > span":{padding:"0 9px 0 0"}}));function Tt(i){const n=new Date().getTime(),{item:o,checkBox:a,handleSetSelectedInvoiceAccount:x,handleViewInvoice:g,setIsRequestLoading:y,setInvoiceId:m,handleOpenHistoryModal:P,selectedPay:v=[],handleGetCorrespondingCurrency:S,addBottom:h}=i,A=W(),k=re(),{id:T,status:L,dueDate:E,openBalance:O}=o,R=O.code||"USD",B=S(R);let z=o.status;L===0&&n>E*1e3&&(z=3);const J=[{key:"orderNumber",title:A("invoice.invoiceItemCardHeader.order"),render:()=>e.jsx(p,{sx:{color:"#000000",cursor:"pointer",textDecoration:"underline"},onClick:()=>{k("/orderDetail/".concat(o.orderNumber))},children:(o==null?void 0:o.orderNumber)||"-"})},{key:"createdAt",title:A("invoice.invoiceItemCardHeader.invoiceDate"),render:()=>"".concat(o.createdAt?K(+o.createdAt):"–")},{key:"updatedAt",title:A("invoice.invoiceItemCardHeader.dueDate"),render:()=>{const{dueDate:d,status:D}=o,C=n>d*1e3&&D!==2;return e.jsx(w,{sx:{color:C?"#D32F2F":"rgba(0, 0, 0, 0.87)",fontSize:"14px"},children:"".concat(o.dueDate?K(+o.dueDate):"–")})}},{key:"originalBalance",title:A("invoice.invoiceItemCardHeader.invoiceTotal"),render:()=>{const{originalBalance:d}=o,D=+d.value;return ne(D||0)}},{key:"openBalance",title:A("invoice.invoiceItemCardHeader.amountDue"),render:()=>{const{openBalance:d}=o,D=+d.value;return ne(D||0)}},{key:"openBalanceToPay",title:A("invoice.invoiceItemCardHeader.amountToPay"),render:()=>{const{openBalance:d,id:D}=o;let C=d.value,$=!0;if(v.length>0){const F=v.find(N=>{const{node:{id:V}}=N;return+V==+D});if(F){const{node:{openBalance:N}}=F;$=!1,C=N.value,+d.value==0&&($=!0)}}return e.jsx(Se,{disabled:$,variant:"filled",value:C,InputProps:{startAdornment:e.jsx(Ie,{position:"start",sx:{padding:"8px 0",marginTop:"0 !important"},children:B||"$"})},sx:{"& input":{paddingTop:"8px"}},onChange:F=>{var V;const N=(V=F.target)==null?void 0:V.value;x(N,D)},type:"number"})}}];return e.jsx(Ce,{sx:{marginBottom:v.length>0&&h?"5rem":0},children:e.jsxs(we,{sx:{color:"rgba(0, 0, 0, 0.6)"},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",mb:"0.5rem"},children:[e.jsx(Ft,{children:a&&a(!!(o!=null&&o.disableCurrentCheckbox))}),e.jsx(w,{variant:"h6",sx:{color:"rgba(0, 0, 0, 0.87)"},children:e.jsx(p,{sx:{color:"#000000",cursor:"pointer",textDecoration:"underline"},onClick:()=>{g(T,L)},children:T||"-"})})]}),e.jsx(p,{sx:{mb:"0.5rem"},children:e.jsx(Fe,{row:o,setInvoiceId:m,handleOpenHistoryModal:P,setIsRequestLoading:y})})]}),e.jsx(p,{sx:{mb:"1rem"},children:e.jsx(Te,{code:z})}),J.map(d=>e.jsxs(p,{sx:{display:"flex",alignItems:"center",mt:"4px"},children:[e.jsx(w,{sx:{fontWeight:"bold",color:"rgba(0, 0, 0, 0.87)",mr:"5px",whiteSpace:"nowrap"},children:"".concat(d.title,":")}),e.jsx(p,{sx:{color:"black",wordBreak:"break-all"},children:d!=null&&d.render?d.render():o[d.key]})]},d.key))]})})}const le={q:"",first:10,offset:0,orderBy:"-".concat(Oe[Le])};function cn(){const i=new Date().getTime(),n=W(),o=M(({company:t})=>t.customer.role),a=M(({b2bFeatures:t})=>t.masqueradeCompany.isAgenting),{invoicePayPermission:x,purchasabilityPermission:g}=M(ke),y=re(),[m]=oe(),P=u.useRef(null),{decimal_places:v=2}=ot(),[S,h]=u.useState(!1),[A,k]=u.useState(!1),[T,L]=u.useState(""),[E,O]=u.useState(""),[R,B]=u.useState(""),[z,J]=u.useState(0),[d,D]=u.useState(0),[C,$]=u.useState([]),[F,N]=u.useState([]),[V,Re]=u.useState([]),[l,_]=u.useState(),[$e,Ne]=u.useState(n("invoice.exportCsvText")),[Ee,ie]=u.useState(!1),[G,ee]=u.useState([]),{state:{bcLanguage:ze}}=u.useContext(st),[He,Ve,Ue]=pt(Oe,Le,l,_),Q=mt(),ae=t=>Object.keys(t).some(s=>s!=="first"&&s!=="offset"&&s!=="orderBy"&&t[s]),Me=t=>{if(Ee){ee(t),ie(!1);return}G.length||ee(t);const s=[...G];t.forEach(r=>{const c=(r==null?void 0:r.node)||r;G.some(b=>b.node.id===c.id)||s.push(r)}),ee(s)},We=async()=>{try{h(!0);const{invoiceStats:t}=await ut(l!=null&&l.status?+l.status:0);if(t){const{overDueBalance:s,totalBalance:r}=t;J(+r.toFixed(v)),D(+s.toFixed(v))}}catch(t){ce.error(t)}finally{h(!1)}},_e=(t,s)=>{t==="search"&&(_({...l,q:s}),ie(!0),B(U.NORMAL))},Ge=t=>{const s=t!=null&&t.startValue?be(new Date(t==null?void 0:t.startValue).getTime()/1e3):"",r=t!=null&&t.endValue?be(new Date(t==null?void 0:t.endValue).getTime()/1e3,!0):"",c=(t==null?void 0:t.status)===3?0:t==null?void 0:t.status,f={status:"".concat(c)||"",beginDateAt:s,endDateAt:r,beginDueDateAt:(t==null?void 0:t.status)===0?parseInt("".concat(i/1e3),10):"",endDueDateAt:(t==null?void 0:t.status)===3?parseInt("".concat(i/1e3),10):""};_({...l,...f}),ie(!0),B(U.NORMAL)},qe=t=>{var s;if(t.length>0){const r=((s=P.current)==null?void 0:s.getCacheList())||[],c=t.map(f=>r.find(j=>{const{node:I}=j;return+I.id==+f}));$([...c])}else $([])},fe=async(t,s)=>{try{h(!0);const c=await xe(t,g&&x&&s!==2);if(!c){Z.error(n("invoice.pdfUrlResolutionError"));return}const{href:f}=window.location;if(!f.includes("invoice"))return;window.open(c,"_blank","fullscreen=yes")}catch(r){ce.error(r)}finally{h(!1)}},Ke=(t,s)=>{const r=C.find(c=>{const{node:{id:f}}=c;return+f==+s});if(F.length>0){const c=F.map(f=>{const{node:{id:b,openBalance:j}}=f,{node:{openBalance:I}}=r;return+b==+s&&(j.value=+I.value<+t?I.value:t),f});N(c)}},Je=async()=>{try{h(!0);const r=((l?ae(l):!1)?G.filter(I=>C.some(H=>{var he,ye;return((he=I==null?void 0:I.node)==null?void 0:he.id)===((ye=H==null?void 0:H.node)==null?void 0:ye.id)})):C).map(I=>I.node.id),c=l!=null&&l.status?[+l.status]:[];let f="-invoice_number";if(l!=null&&l.orderBy){const I=String(l.orderBy);f=I.includes("-")?"-".concat(je[I.split("-")[1]]):je[I]}const b={search:(l==null?void 0:l.q)||"",idIn:"".concat(r||""),orderNumber:"",beginDateAt:(l==null?void 0:l.beginDateAt)||null,endDateAt:(l==null?void 0:l.endDateAt)||null,status:c,orderBy:f},{invoicesExport:j}=await lt({invoiceFilterData:b,lang:ze||"en"});j!=null&&j.url&&window.open(j==null?void 0:j.url,"_blank")}catch(t){ce.error(t)}finally{h(!1)}};u.useEffect(()=>{if(Q!=null&&Q.search){const t=new URLSearchParams(Q.search),s=t.get("invoiceId")||"",r=t.get("receiptId")||"";s&&(_({...le,q:s}),B(U.DETAIL)),r&&(B(U.CHECKOUT),_({...le}),O(r))}else B(U.NORMAL),_({...le})},[Q]),u.useEffect(()=>{const t=C.filter(s=>{const{node:{openBalance:r}}=s;return+r.value!=0})||[];if(t.length>0)if(F.length===0)N(ge(t));else{const s=t.map(r=>{const{node:{id:c,openBalance:f}}=r,b=F.find(j=>{const{node:{id:I}}=j;return+c==+I});if(b){const{node:{openBalance:j}}=b;f.value=j.value}return r});N(ge(s))}else N([])},[C]);const Qe=async t=>{const{invoices:{edges:s,totalCount:r}}=await dt(t),c=s;return R===U.DETAIL&&c.length&&c.forEach(f=>{const b=f;b.node.isCollapse=!0}),c.forEach(f=>{const{node:{openBalance:b}}=f,j=f;j.node.disableCurrentCheckbox=!1,b.value=(+b.value).toFixed(v)}),Re(c),We(),l&&ae(l)&&c.length?Me(c):ee([]),{edges:c,totalCount:r}},me=(t,s)=>{let r=t;if(t.includes(".")){const c=t.split("."),f=c[1].length-+v;if(c[1]&&f>0){const b=c[0]+c[1];r="".concat(b.slice(0,-v),".").concat(b.slice(-v))}}else r.length>1?r="".concat(t.slice(0,1),".").concat(t.slice(-1)):r="".concat(t);Ke(r,s)},Xe=[{key:"id",title:n("invoice.headers.invoice"),isSortable:!0,render:t=>e.jsx(p,{sx:{color:"#000000",cursor:"pointer",":hover":{textDecoration:"underline"}},onClick:()=>{fe(t.id,t.status)},children:t!=null&&t.invoiceNumber?t==null?void 0:t.invoiceNumber:t==null?void 0:t.id}),width:"8%"},{key:"orderNumber",title:n("invoice.headers.order"),isSortable:!0,render:t=>e.jsx(p,{sx:{color:"#000000",cursor:"pointer",":hover":{textDecoration:"underline"}},onClick:()=>{y("/orderDetail/".concat(t.orderNumber))},children:(t==null?void 0:t.orderNumber)||"-"}),width:"8%"},{key:"createdAt",title:n("invoice.headers.invoiceDate"),isSortable:!0,render:t=>"".concat(t.createdAt?K(+t.createdAt):"–"),width:"10%"},{key:"updatedAt",title:n("invoice.headers.dueDate"),isSortable:!0,render:t=>{const{dueDate:s,status:r}=t,c=i>s*1e3&&r!==2;return e.jsx(w,{sx:{color:c?"#D32F2F":"rgba(0, 0, 0, 0.87)",fontSize:"14px"},children:"".concat(t.dueDate?K(+t.dueDate):"–")})},width:"10%"},{key:"originalBalance",title:n("invoice.headers.invoiceTotal"),isSortable:!0,render:t=>{const{originalBalance:s}=t,r=(+s.value).toFixed(v),c=Y(s.code);return"".concat(c).concat(r||0)},width:"10%"},{key:"openBalance",title:n("invoice.headers.amountDue"),isSortable:!0,render:t=>{const{openBalance:s}=t,r=(+s.value).toFixed(v),c=Y(s.code);return"".concat(c).concat(r||0)},width:"10%"},{key:"openBalanceToPay",title:n("invoice.headers.amountToPay"),render:t=>{const{openBalance:s,id:r}=t,c=s.code||"USD";let f=s.value,b=!0;if(F.length>0){const j=F.find(I=>{const{node:{id:H}}=I;return+H==+r});if(j){const{node:{openBalance:I}}=j;b=!1,f=I.value,+s.value==0&&(b=!0)}}return e.jsx(Se,{disabled:b,variant:"filled",value:f||"",InputProps:{startAdornment:e.jsx(Ie,{position:"start",sx:{padding:"8px 0",marginTop:"0 !important"},children:Y(c)})},sx:{"& input":{paddingTop:"8px"},'& input[type="number"]::-webkit-inner-spin-button, & input[type="number"]::-webkit-outer-spin-button':{WebkitAppearance:"none",margin:0}},onChange:j=>{var H;const I=(H=j.target)==null?void 0:H.value;me(I,r)},type:"number"})},width:"15%"},{key:"status",title:n("invoice.headers.status"),isSortable:!0,render:t=>{const{status:s,dueDate:r}=t;let c=t.status;return s===0&&i>r*1e3&&(c=3),e.jsx(Te,{code:c})}},{key:"companyName",title:n("invoice.headers.action"),render:t=>{const{id:s}=t;let r=t;if(F.length>0){const c=F.find(f=>{const{node:{id:b}}=f;return+b==+s});c&&(r=c.node)}return e.jsx(Fe,{row:r,setInvoiceId:L,handleOpenHistoryModal:k,setIsRequestLoading:h})},width:"10%"}];u.useEffect(()=>{let t=n("invoice.exportCsvText");const s=l?ae(l):!1,r=s?G.filter(c=>C.some(f=>{var b,j;return((b=c==null?void 0:c.node)==null?void 0:b.id)===((j=f==null?void 0:f.node)==null?void 0:j.id)})):C;s?t=r.length>0?n("invoice.exportSelectedAsCsv"):n("invoice.exportFilteredAsCsv"):t=r.length>0?n("invoice.exportSelectedAsCsv"):n("invoice.exportCsvText"),Ne(t)},[C,l,G]);const Ye=It.map(t=>{const s=t;return t.name==="status"&&(s.label=n(ve.status)),s.options=t.options.map(r=>{const c=r;return c.label=n(ve[r.key]),r}),t});return e.jsxs(se,{isSpinning:S,children:[e.jsxs(p,{sx:{display:"flex",flexDirection:"column",flex:1,position:"relative"},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:m?"flex-start":"center",flexDirection:m?"column":"row"},children:[e.jsx(xt,{fiterMoreInfo:Ye,handleChange:_e,handleFilterChange:Ge,startPicker:{isEnabled:!0,label:n("invoice.filter.from"),defaultValue:typeof(l==null?void 0:l.beginDateAt)=="number"?+l.beginDateAt*1e3:"",pickerKey:"start"},endPicker:{isEnabled:!0,label:n("invoice.filter.to"),defaultValue:typeof(l==null?void 0:l.endDateAt)=="number"?+l.endDateAt*1e3:"",pickerKey:"end"},searchValue:(l==null?void 0:l.q)||""}),e.jsxs(p,{sx:{display:"flex",marginBottom:"30px",flexDirection:document.body.clientWidth<=465?"column":"row"},children:[e.jsx(w,{sx:{fontSize:"24px",color:"#000000"},children:n("invoice.openUnpaid",{unpaid:ne(z)})}),document.body.clientWidth>=465&&e.jsx(w,{sx:{fontSize:"24px",margin:"0 8px"},children:"|"}),e.jsx(w,{sx:{fontSize:"24px",color:"#D32F2F"},children:n("invoice.overdueAmount",{overdue:ne(d)})})]})]}),e.jsx(rt,{ref:P,columnItems:Xe,rowsPerPageOptions:[10,20,30],getRequestList:Qe,searchParams:l,isCustomRender:!1,requestLoading:h,tableKey:"id",showCheckbox:x&&g,showSelectAllCheckbox:!m&&x&&g,disableCheckbox:!1,applyAllDisableCheckbox:!1,getSelectCheckbox:qe,CollapseComponent:Pt,sortDirection:Ve,orderBy:Ue,sortByFn:He,isSelectOtherPageCheckbox:!0,hover:!0,renderItem:(t,s,r)=>e.jsx(Tt,{item:t,checkBox:r,handleSetSelectedInvoiceAccount:me,handleViewInvoice:fe,setIsRequestLoading:h,setInvoiceId:L,handleOpenHistoryModal:k,selectedPay:F,handleGetCorrespondingCurrency:Y,addBottom:V.length-1===s})}),V.length>0&&!m&&e.jsx(p,{sx:{position:"absolute",bottom:"8px",left:"20px"},children:e.jsx(ue,{variant:"text",onClick:Je,children:$e})})]}),F.length>0&&(o===0||a)&&e.jsx(jt,{selectedPay:F,decimalPlaces:v}),e.jsx(wt,{open:A,currentInvoiceId:T,setOpen:k}),e.jsx(Bt,{receiptId:+E,type:R})]})}export{cn as default};
